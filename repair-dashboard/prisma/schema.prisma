generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model brands {
  id            Int             @id @default(autoincrement())
  name          String          @unique
  isPrimary     Boolean         @default(false)
  logoUrl       String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  device_models device_models[]
}

model customers {
  id                      Int             @id @default(autoincrement())
  lightspeedId            String?         @unique
  firstName               String
  lastName                String
  email                   String?
  phone                   String          @unique
  notificationPreferences String          @default("{\"sms\": true, \"email\": true, \"push\": false}")
  notes                   String?
  isActive                Boolean         @default(true)
  createdAt               DateTime        @default(now())
  updatedAt               DateTime
  lastSyncedAt            DateTime?
  notifications           notifications[]
  repair_orders           repair_orders[]
}

model device_models {
  id            Int             @id @default(autoincrement())
  brandId       Int
  name          String
  modelNumber   String?
  releaseYear   Int?
  deviceType    String
  screenSize    Float?
  isActive      Boolean         @default(true)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime
  brands        brands          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  pricing       pricing[]
  repair_orders repair_orders[]

  @@unique([brandId, name])
}

model notifications {
  id            Int            @id @default(autoincrement())
  repairOrderId Int?
  customerId    Int
  type          String
  eventType     String?
  subject       String?
  message       String
  status        String         @default("pending")
  sentAt        DateTime?
  deliveredAt   DateTime?
  errorMessage  String?
  retryCount    Int            @default(0)
  externalId    String?
  createdAt     DateTime       @default(now())
  updatedAt     DateTime
  customers     customers      @relation(fields: [customerId], references: [id])
  repair_orders repair_orders? @relation(fields: [repairOrderId], references: [id], onDelete: Cascade)
}

model order_status_history {
  id            Int           @id @default(autoincrement())
  repairOrderId Int
  oldStatus     String?
  newStatus     String
  notes         String?
  changedBy     Int?
  changedAt     DateTime      @default(now())
  repair_orders repair_orders @relation(fields: [repairOrderId], references: [id], onDelete: Cascade)
}

model part_types {
  id                 Int                  @id @default(autoincrement())
  name               String               @unique
  qualityLevel       Int
  warrantyMonths     Int                  @default(3)
  description        String?
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  pricing            pricing[]
  repair_order_items repair_order_items[]
}

model photos {
  id            Int           @id @default(autoincrement())
  repairOrderId Int
  photoUrl      String
  photoType     String?
  description   String?
  uploadedBy    Int?
  uploadedAt    DateTime      @default(now())
  repair_orders repair_orders @relation(fields: [repairOrderId], references: [id], onDelete: Cascade)
}

model price_history {
  id        Int      @id @default(autoincrement())
  pricingId Int
  oldPrice  Float?
  newPrice  Float?
  oldCost   Float?
  newCost   Float?
  reason    String?
  changedBy Int?
  changedAt DateTime @default(now())
  pricing   pricing  @relation(fields: [pricingId], references: [id], onDelete: Cascade)
}

model pricing {
  id                 Int                  @id @default(autoincrement())
  deviceModelId      Int
  repairTypeId       Int
  partTypeId         Int
  price              Float
  cost               Float?
  isActive           Boolean              @default(true)
  isEstimated        Boolean              @default(false)
  confidenceScore    Float?
  validFrom          DateTime             @default(now())
  validUntil         DateTime?
  notes              String?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  price_history      price_history[]
  device_models      device_models        @relation(fields: [deviceModelId], references: [id], onDelete: Cascade)
  part_types         part_types           @relation(fields: [partTypeId], references: [id], onDelete: Cascade)
  repair_types       repair_types         @relation(fields: [repairTypeId], references: [id], onDelete: Cascade)
  repair_order_items repair_order_items[]

  @@unique([deviceModelId, repairTypeId, partTypeId])
}

model repair_order_items {
  id              Int           @id @default(autoincrement())
  repairOrderId   Int
  repairTypeId    Int
  partTypeId      Int
  pricingId       Int?
  quantity        Int           @default(1)
  unitPrice       Float
  discount        Float         @default(0)
  totalPrice      Float
  status          String        @default("pending")
  technicianNotes String?
  startedAt       DateTime?
  completedAt     DateTime?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime
  part_types      part_types    @relation(fields: [partTypeId], references: [id])
  pricing         pricing?      @relation(fields: [pricingId], references: [id])
  repair_orders   repair_orders @relation(fields: [repairOrderId], references: [id], onDelete: Cascade)
  repair_types    repair_types  @relation(fields: [repairTypeId], references: [id])
}

model repair_orders {
  id                   Int                    @id @default(autoincrement())
  orderNumber          String                 @unique
  customerId           Int
  deviceModelId        Int
  deviceImei           String?
  deviceSerial         String?
  devicePassword       String?
  status               String                 @default("pending")
  priority             String                 @default("normal")
  issueDescription     String?
  cosmeticCondition    String?
  estimatedCompletion  DateTime?
  actualCompletion     DateTime?
  totalPrice           Float                  @default(0)
  depositPaid          Float                  @default(0)
  assignedTechnicianId Int?
  checkedInBy          Int?
  checkedOutBy         Int?
  lightspeedSaleId     String?
  syncedToLightspeed   Boolean                @default(false)
  syncedAt             DateTime?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  notifications        notifications[]
  order_status_history order_status_history[]
  photos               photos[]
  repair_order_items   repair_order_items[]
  customers            customers              @relation(fields: [customerId], references: [id])
  device_models        device_models          @relation(fields: [deviceModelId], references: [id])
}

model repair_types {
  id                 Int                  @id @default(autoincrement())
  name               String               @unique
  category           String?
  description        String?
  estimatedDuration  Int?
  isActive           Boolean              @default(true)
  createdAt          DateTime             @default(now())
  updatedAt          DateTime
  displayOrder       Int?
  pricing            pricing[]
  repair_order_items repair_order_items[]
}
